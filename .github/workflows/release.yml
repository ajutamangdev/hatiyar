name: Release Hatiyar to PyPI

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Build and Publish to PyPI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-increment version
        id: version_bump
        run: |
          # Get commit message to determine bump type
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"

          # Skip auto-bump if commit contains [skip ci] or is a version bump commit
          if echo "$COMMIT_MSG" | grep -qiE "\[skip ci\]|^chore: auto-bump version"; then
            echo "Skipping version bump (ci skip or auto-bump commit)"
            CURRENT_VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get current version from pyproject.toml
          CURRENT_VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
          echo "Current version in pyproject.toml: $CURRENT_VERSION"

          # Get latest version from PyPI
          PYPI_VERSION=$(curl -s https://pypi.org/pypi/hatiyar/json | grep -Po '"version":"\K[^"]*' | head -1)

          if [ -z "$PYPI_VERSION" ] || [ "$PYPI_VERSION" = "null" ]; then
            # No version on PyPI yet, use version from pyproject.toml
            echo "No version on PyPI yet, using pyproject.toml version: $CURRENT_VERSION"
            NEW_VERSION="$CURRENT_VERSION"
          else
            echo "Latest version on PyPI: $PYPI_VERSION"
            
            # Compare versions: if manual version > PyPI version, use manual
            if [ "$CURRENT_VERSION" != "$PYPI_VERSION" ]; then
              # Simple version comparison
              IFS='.' read -r C_MAJOR C_MINOR C_PATCH <<< "$CURRENT_VERSION"
              IFS='.' read -r P_MAJOR P_MINOR P_PATCH <<< "$PYPI_VERSION"
              
              if [ "$C_MAJOR" -gt "$P_MAJOR" ] || \
                 ([ "$C_MAJOR" -eq "$P_MAJOR" ] && [ "$C_MINOR" -gt "$P_MINOR" ]) || \
                 ([ "$C_MAJOR" -eq "$P_MAJOR" ] && [ "$C_MINOR" -eq "$P_MINOR" ] && [ "$C_PATCH" -gt "$P_PATCH" ]); then
                echo "Manual version bump detected: $PYPI_VERSION → $CURRENT_VERSION"
                echo "   Using manual version (no auto-bump)"
                NEW_VERSION="$CURRENT_VERSION"
              else
                # Auto-bump from PyPI version
                IFS='.' read -r MAJOR MINOR PATCH <<< "$PYPI_VERSION"
                
                # Determine version bump based on conventional commits
                if echo "$COMMIT_MSG" | grep -qiE "^BREAKING CHANGE:|^[a-z]+(\([a-z]+\))?!:"; then
                  # Breaking changes → MAJOR bump
                  MAJOR=$((MAJOR + 1))
                  MINOR=0
                  PATCH=0
                  BUMP_TYPE="MAJOR (breaking change)"
                elif echo "$COMMIT_MSG" | grep -qiE "^feat(\([a-z]+\))?:"; then
                  # New features → MINOR bump
                  MINOR=$((MINOR + 1))
                  PATCH=0
                  BUMP_TYPE="MINOR (feat)"
                elif echo "$COMMIT_MSG" | grep -qiE "^(fix|perf|refactor)(\([a-z]+\))?:"; then
                  # Bug fixes, performance, refactoring → PATCH bump
                  PATCH=$((PATCH + 1))
                  BUMP_TYPE="PATCH (fix/perf/refactor)"
                elif echo "$COMMIT_MSG" | grep -qiE "^(docs|style|test|build|ci|chore)(\([a-z]+\))?:"; then
                  # Docs, style, tests, build, ci, chore → PATCH bump
                  PATCH=$((PATCH + 1))
                  BUMP_TYPE="PATCH (docs/style/test/build/ci/chore)"
                else
                  # Unknown commit type → PATCH bump
                  PATCH=$((PATCH + 1))
                  BUMP_TYPE="PATCH (other)"
                fi
                
                NEW_VERSION="$MAJOR.$MINOR.$PATCH"
                echo "Auto-bumping: $PYPI_VERSION → $NEW_VERSION ($BUMP_TYPE)"
                
                # Update pyproject.toml with new version
                sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" pyproject.toml
                
                # Commit and push the version bump
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git add pyproject.toml
                git commit -m "chore: auto-bump version to $NEW_VERSION [skip ci]"
                git push
              fi
            else
              # Same version in both, need to bump
              IFS='.' read -r MAJOR MINOR PATCH <<< "$PYPI_VERSION"
              
              if echo "$COMMIT_MSG" | grep -qiE "^BREAKING CHANGE:|^[a-z]+(\([a-z]+\))?!:"; then
                # Breaking changes → MAJOR bump
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                BUMP_TYPE="MAJOR (breaking change)"
              elif echo "$COMMIT_MSG" | grep -qiE "^feat(\([a-z]+\))?:"; then
                # New features → MINOR bump
                MINOR=$((MINOR + 1))
                PATCH=0
                BUMP_TYPE="MINOR (feat)"
              elif echo "$COMMIT_MSG" | grep -qiE "^(fix|perf|refactor)(\([a-z]+\))?:"; then
                # Bug fixes, performance, refactoring → PATCH bump
                PATCH=$((PATCH + 1))
                BUMP_TYPE="PATCH (fix/perf/refactor)"
              elif echo "$COMMIT_MSG" | grep -qiE "^(docs|style|test|build|ci|chore)(\([a-z]+\))?:"; then
                # Docs, style, tests, build, ci, chore → PATCH bump
                PATCH=$((PATCH + 1))
                BUMP_TYPE="PATCH (docs/style/test/build/ci/chore)"
              else
                # Unknown commit type → PATCH bump
                PATCH=$((PATCH + 1))
                BUMP_TYPE="PATCH (other)"
              fi
              
              NEW_VERSION="$MAJOR.$MINOR.$PATCH"
              echo "Auto-bumping: $PYPI_VERSION → $NEW_VERSION ($BUMP_TYPE)"
              
              sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" pyproject.toml
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add pyproject.toml
              git commit -m "chore: auto-bump version to $NEW_VERSION [skip ci]"
              git push
            fi
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Build package
        run: uv build --no-sources

      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: uv publish
